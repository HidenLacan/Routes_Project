<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dibujar Polígono</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 50vh; width: 50%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script>
    fetch("/datos")
      .then(res => res.json())
      .then(data => {
        const [south, north, west, east] = data.bbox;
        const bounds = L.latLngBounds([south, west], [north, east]);

        const map = L.map("map").fitBounds(bounds);

        // Base layer
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "Map data © OpenStreetMap contributors"
        }).addTo(map);

        // Bounding box visual
        L.rectangle(bounds, {
          color: "orange",
          weight: 2,
          fillOpacity: 0.1
        }).addTo(map).bindTooltip(data.nombre);

        // Dibujo
        const drawnItems = new L.FeatureGroup().addTo(map);
        map.addControl(new L.Control.Draw({
          draw: { polygon: true, marker: false, polyline: false, circle: false, rectangle: false, circlemarker: false },
          edit: { featureGroup: drawnItems }
        }));

        map.on("draw:created", function (e) {
          const layer = e.layer;
          drawnItems.addLayer(layer);

          const geojson = layer.toGeoJSON();
          const payload = {
                nombre: data.nombre,
                ...geojson
              };    

          fetch("/guardar_poligono", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
                })    
          .then(res => res.json())
          .then(resp => alert(resp.message))
          .catch(err => alert("❌ Error al guardar polígono"));
        });
      });
  </script>
</body>
</html>
